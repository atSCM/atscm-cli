{"version":3,"sources":["../src/AtSCMCli.js"],"names":["AtSCMCli","BinName","Object","keys","bin","ConfigName","_reportCliError","err","error","colors","red","message","info","help","debug","stack","SyntaxError","_failedRequires","length","join","process","exitCode","constructor","argv","name","configName","extensions","on","magenta","push","runViaCli","require","resolve","_argv","commandNames","map","c","options","version","env","option","fail","msg","e","y","_","filter","includes","unshift","applyOptions","globalOptionNames","argumentsParser","reduce","parser","command","usage","description","group","strict","desc","demandCommand","global","alias","_exposeOverride","config","key","base","currentKey","toUpperCase","forEach","k","format","value","parseArguments","Promise","reject","parse","project","getEnvironment","findUp","launch","cwd","configPath","projectfile","environment","requireEnvironment","then","modulePath","Error","getVersion","cli","local","modulePackage","printVersion","number","runCommand","requiresEnvironment","run","warn","app","ATSCM_DEBUG","install","catch"],"mappings":"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","file":"AtSCMCli.js","sourcesContent":["import { realpathSync } from 'fs';\nimport { join } from 'path';\nimport { EOL } from 'os';\nimport Liftoff from 'liftoff';\nimport yargs from 'yargs';\nimport gulplog from 'gulplog';\nimport { jsVariants } from 'interpret';\nimport { yellow } from 'chalk';\nimport pkg from '../package.json';\nimport Logger from './lib/util/Logger';\nimport Options, { GlobalOptions } from './cli/Options';\nimport Commands from './cli/Commands';\nimport UsageError from './lib/error/UsageError';\n\n/**\n * The main class. Handles arguments and runs commands.\n * @extends {Liftoff}\n */\nexport default class AtSCMCli extends Liftoff {\n\n  /**\n   * The name under which the module is available from the command line.\n   * @type {string}\n   */\n  static get BinName() {\n    return Object.keys(pkg.bin)[0];\n  }\n\n  /**\n   * The filename used for configuration files.\n   * @type {string}\n   */\n  static get ConfigName() {\n    return 'Atviseproject';\n  }\n\n  /**\n   * Reports an error and exits the process with return code `1`.\n   * @param {Error} err The error that occurred.\n   */\n  _reportCliError(err) {\n    Logger.error(Logger.colors.red(err.message));\n\n    if (err instanceof UsageError) {\n      Logger.info(err.help);\n    } else {\n      Logger.debug(err.stack);\n\n      if (err instanceof SyntaxError && this._failedRequires.length) {\n        Logger.info(yellow(`You may have to install the '${this._failedRequires[0]}' module.`));\n        Logger.info(['Other failed requires:', ...this._failedRequires].join(`${EOL} - `));\n      }\n    }\n\n    process.exitCode = 1;\n  }\n\n  /**\n   * Creates a new {@link AtSCMCli} object based on command line arguments.\n   * @param {string[]} argv The command line arguments to use. If no command is provided and neither\n   * `--help` nor `--version` are used, the command `run` is added.\n   * @throws {UsageError} Throws an error if option parsing fails.\n   */\n  constructor(argv = []) {\n    super({\n      name: AtSCMCli.BinName,\n      configName: AtSCMCli.ConfigName,\n      extensions: jsVariants,\n    });\n\n    this.on('require', function(name) {\n      Logger.debug('Requiring external module', Logger.colors.magenta(name));\n    });\n\n    /** If requiring an external module failed.\n     * @type {string[]} */\n    this._failedRequires = [];\n\n    this.on('requireFail', function(name) {\n      this._failedRequires.push(name);\n\n      Logger.debug(\n        Logger.colors.red('Failed to load external module'),\n        Logger.colors.magenta(name)\n      );\n    });\n\n    /**\n     * `true` if the instance was created by running the binaries, `false` if used programmatically.\n     * @type {Boolean}\n     */\n    this.runViaCli = realpathSync(process.argv[1]) === require.resolve('./bin/atscm');\n\n    /**\n     * The raw, unparsed command line arguments the Cli was created with.\n     * @type {String[]}\n     */\n    this._argv = argv;\n\n    // If no command is given, default to \"run\"\n    const commandNames = Commands.map(c => c.name);\n\n    /**\n     * The options parsed from {@link AtSCMCli#_argv}. Note that **these options are not complete**\n     * until {@link AtSCMCli#launch} was called.\n     * @type {Object}\n     */\n    this.options = yargs(argv)\n      .version(false)\n      .help(false)\n      .env('ATSCM')\n      .option(GlobalOptions)\n      .fail((msg, e, y) => {\n        const err = new UsageError(msg, y.help());\n\n        if (this.runViaCli) {\n          gulplog.on('error', () => {}); // Prevent logger to throw an error\n\n          this._reportCliError(err);\n        } else {\n          throw err;\n        }\n      })\n      .argv;\n\n    if (!this.options.help && !this.options.version) {\n      if (this.options._.filter(e => commandNames.includes(e)).length === 0) {\n        this._argv.unshift('run');\n      }\n    }\n\n    // Initialize logger\n    Logger.applyOptions(this.options);\n\n    const globalOptionNames = Object.keys(GlobalOptions);\n\n    /**\n     * An instance of {@link yargs} responible for parsing options.\n     * @type {yargs}\n     */\n    this.argumentsParser = Commands\n      .reduce(\n        (parser, command) => parser\n          .command(command.usage, command.description, y => {\n            y.usage(`Usage: $0 ${command.usage}`);\n            y.option(command.options);\n\n            y.group(Object.keys(command.options), 'Command specific options:');\n            y.group(globalOptionNames, 'Global options:');\n\n            y.strict(command.strict);\n            y.help('help', Options.help.desc);\n            y.demandCommand(...command.demandCommand);\n          }, () => (this.command = command)),\n        yargs()\n          .env('ATSCM')\n          .usage('Usage: $0 [cmd=run]')\n          .version(false)\n          .options(GlobalOptions)\n          .global(globalOptionNames)\n          .strict()\n          .help('help', Options.help.desc)\n          .alias('help', 'h')\n      );\n  }\n\n  /**\n   * Used to expose project config overrides via environment variables. All project options are\n   * exposed as `ATSCM_PROJECT__{KEY}={VALUE}`.\n   * @param {Object} config The object to expose.\n   * @param {string} key The key currently handled.\n   * @param {string} [base=ATSCM_PROJECT__] The parent key.\n   */\n  _exposeOverride(config, key, base = 'ATSCM_PROJECT__') {\n    const currentKey = `${base}${key.toUpperCase()}`;\n\n    if (typeof config[key] === 'object') {\n      const c = config[key];\n\n      Object.keys(c).forEach(k => this._exposeOverride(c, k, `${currentKey}__`));\n    } else {\n      process.env[currentKey] = config[key];\n      Logger.debug(`Setting ${currentKey}:`, Logger.format.value(config[key]));\n    }\n  }\n\n  /**\n   * Parses arguments and exposes the project options as environment variables.\n   * @return {Promise<Object, UsageError>} Rejected with a {@link UsageError} if parsing failed,\n   * otherwise fulfilled with the parsed arguments.\n   */\n  parseArguments() {\n    return new Promise((resolve, reject) => {\n      this.options = this.argumentsParser\n        .fail((msg, err, y) => reject(new UsageError(msg, y.help())))\n        .parse(this._argv);\n\n      Object.keys(this.options.project)\n        .forEach(key => this._exposeOverride(this.options.project, key));\n\n      resolve(this.options);\n    });\n  }\n\n  /**\n   * Returns a {@link Liftoff.Environment} for the Cli.\n   * @param {boolean} [findUp=false] If the environment should be searched for in parent\n   * directories.\n   * @return {Promise<Object>} Fulfilled with a {@link Liftoff} environment.\n   */\n  getEnvironment(findUp = true) {\n    return new Promise(resolve => {\n      super.launch({\n        cwd: this.options.cwd,\n        configPath: findUp ?\n          this.options.projectfile :\n          join((this.options.cwd || process.cwd()), `${this.constructor.ConfigName}.js`),\n        require: this.options.require,\n      }, env => resolve(this.environment = env));\n    });\n  }\n\n  /**\n   * Gets a {@link Liftoff.Environment} and validates a config file and a local module was found.\n   * @return {Promise<Object, Error>} Resolved with the {@link Liftoff environment}, rejected if the\n   * config file or the local module cannot be found.\n   */\n  requireEnvironment() {\n    return this.getEnvironment()\n      .then(env => {\n        if (!env.modulePath) {\n          throw new Error(`Local ${AtSCMCli.BinName} not found`);\n        }\n\n        if (!env.configPath) {\n          throw new Error('No config file found');\n        }\n\n        return env;\n      });\n  }\n\n  /**\n   * Returns the CLI version and, if a local module could be found, the local version.\n   * @return {Promise<{cli: string, local: ?string}>} Fulfilled with the found cli and local\n   * version.\n   */\n  getVersion() {\n    return this.getEnvironment()\n      .then(env => ({\n        cli: pkg.version,\n        local: env.modulePath ? env.modulePackage.version : null,\n      }));\n  }\n\n  /**\n   * Gets and prints the CLI version and, if a local module could be found, the local version.\n   * @return {Promise<{cli: string, local: ?string}>} Fulfilled with the found cli and local\n   * version.\n   */\n  printVersion() {\n    return this.getVersion()\n      .then(version => {\n        Logger.info('CLI version', Logger.format.number(version.cli));\n\n        if (version.local) {\n          Logger.info('Local version', Logger.format.number(version.local));\n        }\n\n        return version;\n      });\n  }\n\n  /**\n   * Runs the command specified in the command line arguments ({@link AtSCMCli#_argv}). **Note that\n   * this will only work if {@link AtSCMCli#parseArguments} was called before.**.\n   * @return {Promise<*, Error>} Fulfilled if the command succeeded.\n   */\n  runCommand() {\n    if (this.options.version) {\n      return this.printVersion();\n    }\n\n    if (this.command) {\n      return (this.command.requiresEnvironment(this) ?\n        this.requireEnvironment() :\n        Promise.resolve()\n      )\n        .then(() => this.command.run(this));\n    }\n\n    Logger.warn('No command specified');\n\n    return Promise.resolve(this);\n  }\n\n  /**\n   * Parses arguments and runs the specified command.\n   * @return {Promise<*, Error>} Fulfilled if the command succeeded. Note that, if the instance is\n   * run through the binary all rejections will be handled.\n   */\n  launch() {\n    const app = this.parseArguments()\n      .then(() => {\n        if (process.env.ATSCM_DEBUG || this.options.debug) {\n          process.env.ATSCM_DEBUG = process.env.ATSCM_DEBUG || 'true';\n          require('source-map-support').install(); // eslint-disable-line global-require\n        }\n      })\n      .then(() => this.runCommand());\n\n    if (this.runViaCli) {\n      return app\n        .catch(err => this._reportCliError(err));\n    }\n\n    return app;\n  }\n\n}\n"]}